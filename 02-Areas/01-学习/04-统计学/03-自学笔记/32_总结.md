# 第十章 方差分析 (ANOVA)
## 第一节 单因素方差分析 (One-Way ANOVA)
单因素方差分析的核心思想：**比较组和组之间的差异（可能由因素水平引起）与组内部的差异（随机或个体差异），看哪个占主导。** 
### 1. 引言：方差分析的目的
-   **目的**：通过分析 **方差 (Variance)** 来检验 **多个 (k > 2)** **总体均值**是否 **全部相等**。
-   **本质**：一种假设检验方法。
### 2. 假设检验的设定
以 $k=3$ 个总体为例：
-   **原假设 ($H_0$)**：所有总体均值都相等。
    $$ H_0: \mu_1 = \mu_2 = \mu_3 $$
-   **备择假设 ($H_1$)**：总体均值 **不全相等** (至少有两个不相等)。
    $$ H_1: \text{并非所有的 } \mu_i \text{ 都相等} $$
    [!WARNING]
    $H_1$ 不是 $\mu_1 \ne \mu_2 \ne \mu_3$ (全部不相等)，而是 $H_0$ 的否定。
### 3. 为何不用多次 t 检验？
-   **问题**：能否将 $H_0: \mu_1 = \mu_2 = \mu_3$ 拆分为多个两两比较的 t 检验？
    -   $H_{01}: \mu_1 = \mu_2$
    -   $H_{02}: \mu_1 = \mu_3$
    -   $H_{03}: \mu_2 = \mu_3$
-   **缺点**：
    1.  **增加犯第一类错误的概率 (Increased Type I Error Rate)**：
        -   假设每次 t 检验的显著性水平 (犯第一类错误的概率) 为 $\alpha$。
        -   每次检验不拒绝 $H_0$ 的概率为 $1-\alpha$。
        -   要使原始 $H_0$ 成立，必须 **同时** 不拒绝所有 $c$ 个 (例如 $k=3$ 时 $c=3$) 两两比较的原假设。
        -   同时不拒绝的概率为 $(1-\alpha)^c$。
        -   那么，至少拒绝一个（即拒绝原始 $H_0$）的概率为 $1 - (1-\alpha)^c$。
        -   当 $c > 1$ 时，$1 - (1-\alpha)^c > \alpha$。
        -   **结论**：进行多次 t 检验会导致整个检验的实际第一类错误率膨胀，远超预设的 $\alpha$ 水平。总体数量 $k$ 越多，两两组合 $c$ 越多，错误率膨胀越严重。
    2.  **繁琐 (Cumbersome)**：
        -   需要进行的比较次数 $c = \binom{k}{2} = \frac{k(k-1)}{2}$ 会随 $k$ 增加而迅速增多。
-   **方差分析的优势**：从 **整体** 角度出发，一次性检验所有均值是否相等，克服了上述缺点。
### 4. 方差分析的基本假定 (Assumptions)
使用方差分析的前提条件：
1.  **正态性 (Normality)**：每个总体都服从正态分布。
    -   $x_{ij} \sim N(\mu_i, \sigma^2)$ (第 $i$ 个总体的第 $j$ 个观测值)
2.  **方差齐性 (Homogeneity of Variances)**：所有总体的方差都相等。
    -   $\sigma_1^2 = \sigma_2^2 = \ldots = \sigma_k^2 = \sigma^2$ (共同方差)
3.  **独立性 (Independence)**：所有观测值都是独立的 (无论是组内还是组间)。
4. ![image.png](https://raw.githubusercontent.com/SAMLAY-c/obsidian-photos/university/img/20250503013833153.png)
**图形理解**：
-   在满足基本假定时，各总体的分布曲线是 **高矮胖瘦相同** (方差齐性) 的正态曲线，但 **位置可能不同** (均值可能不同)。
-   **如果 $H_0$ 成立** ($\mu_1 = \mu_2 = \ldots = \mu_k = \mu$)，则所有总体的分布曲线将 **完全重合**，意味着所有样本实际上都来自于 **同一个正态总体** $N(\mu, \sigma^2)$。
### 5. 方差分析的核心：方差分解 (Variance Decomposition)
-   **目标**：分析样本数据的总波动，并将其分解为不同来源的波动。
-   **符号定义**：
    -   $k$: 总体/组的数量
    -   $n_i$: 第 $i$ 组的样本量
    -   $n = \sum_{i=1}^{k} n_i$: 总样本量
    -   $x_{ij}$: 第 $i$ 组的第 $j$ 个观测值
    -   $\bar{\bar{x}} = \frac{\sum_{i=1}^{k} \sum_{j=1}^{n_i} x_{ij}}{n}$: **总均值 (Grand Mean)**
    -   $\bar{x}_i = \frac{\sum_{j=1}^{n_i} x_{ij}}{n_i}$: 第 $i$ 组的 **样本均值 (Group Mean)**
-   **总平方和 (Total Sum of Squares, SST)**：
    -   定义：所有观测值与其总均值的离差平方和。
    -   公式：$SST = \sum_{i=1}^{k} \sum_{j=1}^{n_i} (x_{ij} - \bar{\bar{x}})^2$
    -   含义：衡量样本数据的 **总波动**。
-   **组间平方和 (Sum of Squares Between Groups / Among Groups, SSA)**：
    -   定义：各组均值与总均值的离差平方和，按各组样本量加权。
    -   公式：$SSA = \sum_{i=1}^{k} n_i (\bar{x}_i - \bar{\bar{x}})^2$
    -   含义：衡量 **不同组之间** 的波动，反映了由 **分组因素 (Factor)** 不同水平 (Level) 引起的差异。
		![image.png](https://raw.githubusercontent.com/SAMLAY-c/obsidian-photos/university/img/20250503044401730.png)
-   **组内平方和 (Sum of Squares Within Groups / Error, SSE)**：
    -   定义：每组内部各观测值与其组均值的离差平方和的总和。
    -   公式：$SSE = \sum_{i=1}^{k} \sum_{j=1}^{n_i} (x_{ij} - \bar{x}_i)^2 = \sum_{i=1}^{k} (n_i - 1) s_i^2$ (其中 $s_i^2$ 是第 $i$ 组的样本方差)
    -   含义：衡量 **各组内部** 的随机波动，也称为 **误差平方和 (Error Sum of Squares)**，代表了不能被分组因素解释的波动。
    - ![image.png](https://raw.githubusercontent.com/SAMLAY-c/obsidian-photos/university/img/20250503043601990.png)
-   **基本关系式**：总波动可以分解为组间波动和组内波动之和。
    $$ SST = SSA + SSE $$
    *证明概要：通过在 $(x_{ij} - \bar{\bar{x}})$ 中加入和减去 $\bar{x}_i$，即 $(x_{ij} - \bar{x}_i + \bar{x}_i - \bar{\bar{x}})$，然后平方展开求和，交叉项 $\sum_{i=1}^{k} \sum_{j=1}^{n_i} 2(x_{ij} - \bar{x}_i)(\bar{x}_i - \bar{\bar{x}})$ 等于零。
		    ![image.png](https://raw.githubusercontent.com/SAMLAY-c/obsidian-photos/university/img/20250503045050705.png)
- 总结- 
![image.png](https://raw.githubusercontent.com/SAMLAY-c/obsidian-photos/university/img/20250503015645629.png)
19：33
### 6. 均方 (Mean Squares) 与 F 统计量
-   **自由度 (Degrees of Freedom, df)**：
    -   总自由度：$df_T = n - 1$
    -   组间自由度：$df_A = k - 1$
    -   组内自由度：$df_E = n - k$
    -   关系：$df_T = df_A + df_E$
-   **均方 (Mean Square, MS)**：平方和除以其对应的自由度。
    -   **组间均方 (Mean Square Among Groups)**：
        $$ MSA = \frac{SSA}{df_A} = \frac{SSA}{k-1} $$
        *含义：组间方差的估计值，受组间差异和随机误差共同影响。*
    -   **组内均方 (Mean Square Within Groups / Error)**：
        $$ MSE = \frac{SSE}{df_E} = \frac{SSE}{n-k} $$
        *含义：组内方差 (共同方差 $\sigma^2$) 的无偏估计值，只反映随机误差。可视为所有组方差的加权平均估计 (Pooled Variance Estimate)。*
-   **F 检验统计量 (F-Statistic)**：
    -   定义：组间均方与组内均方的比值。
        $$ F = \frac{MSA}{MSE} $$
    -   **逻辑**：
        -   如果 $H_0$ 成立 (各组均值相等)，则组间波动主要也来自随机误差，此时 $MSA$ 和 $MSE$ 都趋近于 $\sigma^2$，F 值趋近于 1。
        -   如果 $H_1$ 成立 (各组均值不全相等)，则组间差异增大，导致 $SSA$ 和 $MSA$ 增大，而 $MSE$ 不受系统性组间差异影响 (仍估计 $\sigma^2$)，此时 F 值会大于 1。
        -   F 值越大，越倾向于拒绝 $H_0$。
    -   **分布 (在 $H_0$ 成立时)**：F 统计量服从 F 分布，其自由度为分子自由度 $df_A = k-1$ 和分母自由度 $df_E = n-k$。
        $$ F \sim F(k-1, n-k) $$
        *推导概要 (基于 $H_0$ 成立)：*
        * $SSE / \sigma^2 \sim \chi^2(n-k)$
        * $SSA / \sigma^2 \sim \chi^2(k-1)$
        * $F = \frac{MSA}{MSE} = \frac{SSA/(k-1)}{SSE/(n-k)} = \frac{(SSA/\sigma^2)/(k-1)}{(SSE/\sigma^2)/(n-k)} \sim F(k-1, n-k)$
### 7. 方差分析表 (ANOVA Table)
通常将方差分析的计算结果整理成表格：
| 变异来源 (Source of Variation) | 平方和 (Sum of Squares, SS) | 自由度 (df) | 均方 (Mean Square, MS) | F 值 (F-statistic) | P 值 (P-value) | F 临界值 (F-critical) |
| :----------------------------- | :-------------------------- | :---------- | :--------------------- | :----------------- | :------------- | :-------------------- |
| **组间 (Among Groups / Factor)** | SSA                         | $k-1$       | $MSA = SSA/(k-1)$      | $F = MSA/MSE$      | P(>F)          | $F_{\alpha}(k-1, n-k)$ |
| **组内 (Within Groups / Error)** | SSE                         | $n-k$       | $MSE = SSE/(n-k)$      |                    |                |                       |
| **总计 (Total)** | SST                         | $n-1$       |                        |                    |                |                       |
### 8. 检验准则与决策
-   **检验类型**： **右侧单尾检验 (Right-tailed test)**。因为只有当 $MSA$ 显著大于 $MSE$ 时 (即 F 值显著大于 1 时)，才支持 $H_1$。
-   **决策规则**：
    1.  **比较 F 值与临界值**：
        -   计算得到的 F 统计量值 $F_{calc} = \frac{MSA}{MSE}$。
        -   查找给定显著性水平 $\alpha$ 下的临界值 $F_{crit} = F_{\alpha}(k-1, n-k)$。
        -   如果 $F_{calc} > F_{crit}$，则拒绝 $H_0$。
        -   如果 $F_{calc} \le F_{crit}$，则不拒绝 $H_0$。
    2.  **比较 P 值与 $\alpha$**：
        -   计算 F 统计量对应的 P 值 (即 $P(F(k-1, n-k) \ge F_{calc})$)。
        -   如果 $P \le \alpha$，则拒绝 $H_0$。
        -   如果 $P > \alpha$，则不拒绝 $H_0$。
### 9. 方差分析与因素、水平
-   **因素 (Factor)**：引起变异的 **分类变量** (例如：行业、肥料种类、教学方法)。
-   **水平 (Level) / 处理 (Treatment)**：因素的具体表现或取值 (例如：零售业/旅游业/航空业/家电业；肥料 A/B/C/D；方法 1/2/3)。
-   **单因素方差分析**：研究 **一个** 分类因素的不同水平对一个 **数值型变量** (响应变量，如：投诉数量、亩产量、考试成绩) 的均值是否有显著影响。
-   **假设的含义**：
    -   $H_0$: 该分类因素对数值型变量的均值 **没有** 显著影响。
    -   $H_1$: 该分类因素对数值型变量的均值 **有** 显著影响。
### 10. 关系强度的测量 (Measuring Association Strength)
-   **判定系数 $R^2$ (Coefficient of Determination)**：
    -   定义：组间平方和 (由因素解释的变异) 占总平方和 (总变异) 的比例。
        $$ R^2 = \frac{SSA}{SST} = 1 - \frac{SSE}{SST} $$
    -   取值范围：$0 \le R^2 \le 1$。
    -   含义：表示数值型变量的总变异中，可以由该分类因素解释的 **百分比**。$R^2$ 越大，说明因素对变量的影响越大，关系越强。
-   **相关系数 R (Correlation Ratio)**：
    -   定义：$R = \sqrt{R^2}$
    -   含义：衡量分类因素与数值型变量之间关系强度的指标 (注意：这里不是皮尔逊相关系数)。
### 11. 多重比较 (Multiple Comparisons / Post-Hoc Tests)
-   **目的**：当 ANOVA 检验 **拒绝 $H_0$** (即认为均值不全相等) 后，进一步确定 **具体哪些** 总体均值之间存在显著差异。
-   **常用方法：LSD (Least Significant Difference) 最小显著差法**
    -   **原理**：对所有可能的总体均值对 $(\mu_i, \mu_j)$ 进行两两 t 检验。
    -   **检验统计量 (基于 ANOVA 假定)**：
        -   任意两组样本均值之差 $\bar{x}_i - \bar{x}_j$ 服从正态分布：
          $\bar{x}_i - \bar{x}_j \sim N(\mu_i - \mu_j, \sigma^2(\frac{1}{n_i} + \frac{1}{n_j}))$
        -   用 **MSE** (所有组内方差的合并估计，是 $\sigma^2$ 的最佳估计) 替换未知的 $\sigma^2$。
        -   构造 t 统计量：
            $$ t = \frac{(\bar{x}_i - \bar{x}_j) - (\mu_i - \mu_j)}{\sqrt{MSE \left(\frac{1}{n_i} + \frac{1}{n_j}\right)}} \sim t(n-k) $$
            *自由度为 MSE 的自由度 $n-k$。*
    -   **LSD 值的计算**：
        -   在 $H_0: \mu_i = \mu_j$ 成立时，拒绝域边界对应的 $(\bar{x}_i - \bar{x}_j)$ 的差值。
            $$ LSD = t_{\alpha/2}(n-k) \sqrt{MSE \left(\frac{1}{n_i} + \frac{1}{n_j}\right)} $$
            *$t_{\alpha/2}(n-k)$ 是自由度为 $n-k$ 的 t 分布上侧 $\alpha/2$ 分位数。*
    -   **决策规则**：
        -   计算样本均值差的绝对值 $|\bar{x}_i - \bar{x}_j|$。
        -   计算对应的 LSD 值。
        -   如果 $|\bar{x}_i - \bar{x}_j| \ge LSD$，则拒绝 $H_0: \mu_i = \mu_j$，认为 $\mu_i$ 和 $\mu_j$ 之间存在显著差异。
        -   如果 $|\bar{x}_i - \bar{x}_j| < LSD$，则不拒绝 $H_0: \mu_i = \mu_j$。
    [!NOTE]
    LSD 方法只是多重比较方法的一种，在进行多次比较时，仍可能略微增加总体犯第一类错误的概率 (但比完全独立的 t 检验要好，因为它使用了统一的 MSE 估计)。还有其他更保守的方法，如 Tukey's HSD, Bonferroni 校正等。
